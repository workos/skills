---
name: workos-vault
description: Encrypt, store, and manage sensitive data with WorkOS Vault.
---

<!-- generated -->

# WorkOS Vault

## Step 1: Fetch Documentation (BLOCKING)

**STOP. Do not proceed until complete.**

WebFetch these URLs for latest implementation details:
- https://workos.com/docs/vault/quick-start
- https://workos.com/docs/vault/key-context
- https://workos.com/docs/vault/index
- https://workos.com/docs/vault/byok

The documentation is the source of truth. If this skill conflicts with docs, follow docs.

## Step 2: Pre-Flight Validation

### Environment Variables

Check for required WorkOS credentials:

```bash
# MUST exist in .env or environment
grep -E "WORKOS_API_KEY|WORKOS_CLIENT_ID" .env .env.local 2>/dev/null
```

Required format:
- `WORKOS_API_KEY` - starts with `sk_`
- `WORKOS_CLIENT_ID` - starts with `client_`

### Project Structure

```bash
# Confirm package.json exists
test -f package.json && echo "PASS" || echo "FAIL: No package.json"
```

## Step 3: Install WorkOS SDK

Detect package manager and install SDK:

```bash
# Check package manager
if [ -f "pnpm-lock.yaml" ]; then
  pnpm add @workos-inc/node
elif [ -f "yarn.lock" ]; then
  yarn add @workos-inc/node
else
  npm install @workos-inc/node
fi
```

**Verify installation:**

```bash
# Confirm SDK exists in node_modules
test -d node_modules/@workos-inc/node && echo "PASS" || echo "FAIL: SDK not installed"
```

## Step 4: Organization Setup (REQUIRED)

**CRITICAL:** Vault operations require a WorkOS Organization ID. Each encrypted object is scoped to an organization.

### Check Existing Organizations

Query WorkOS API to list organizations:

```bash
curl -X GET "https://api.workos.com/organizations" \
  -H "Authorization: Bearer $WORKOS_API_KEY" \
  -H "Content-Type: application/json"
```

### Decision Tree: Organization Strategy

```
Organization exists for target customer?
  |
  +-- YES --> Use existing organization_id in key context
  |
  +-- NO  --> Create organization via Dashboard or API
              |
              +-- Via Dashboard: https://dashboard.workos.com/organizations
              |
              +-- Via API: POST /organizations
                          {
                            "name": "Customer Name",
                            "domains": ["customer.com"]
                          }
```

**Store organization ID:** You'll need this for Step 6 (key context).

## Step 5: Key Context Design (CRITICAL DECISION)

**Key context determines encryption key cardinality.** This is a fundamental design choice.

### Key Context Rules

From fetched docs, enforce these limits:
- Maximum 10 key-value pairs per context
- All values MUST be strings
- Context is immutable after object creation

### Common Patterns

```
Use Case                    --> Key Context
────────────────────────────────────────────────────
Per-organization isolation  --> {"organization_id": "org_123"}

Per-user isolation          --> {"organization_id": "org_123", "user_id": "user_456"}

Per-tenant + type          --> {"organization_id": "org_123", "data_type": "credentials"}

Multi-tenant with regions  --> {"organization_id": "org_123", "region": "us-west-2"}
```

**Decision:** Choose granularity NOW. You cannot change key context later for existing objects.

## Step 6: Create Encrypted Object

SDK method from fetched docs: Look for `vault.createObject()` or similar.

**Minimal implementation pattern:**

```typescript
import { WorkOS } from '@workos-inc/node';

const workos = new WorkOS(process.env.WORKOS_API_KEY);

// Create encrypted object
const object = await workos.vault.createObject({
  keyContext: {
    organization_id: 'org_123' // From Step 4
  },
  value: JSON.stringify({
    apiKey: 'secret_value',
    credentials: 'sensitive_data'
  })
});

// Store object.name for retrieval
console.log('Object name:', object.name);
```

**CRITICAL:** Save `object.name` to your database. This is the identifier for retrieval.

### Object Naming

Object names can be:
- Auto-generated by WorkOS (recommended for first integration)
- Custom names (check docs for format restrictions)

## Step 7: Retrieve Encrypted Object

**Three retrieval methods** (from fetched docs):

```
Operation Needed     --> Method
─────────────────────────────────────────
List object names    --> vault.listObjects()
Get metadata only    --> vault.getObjectMetadata()
Decrypt value        --> vault.getObject()
```

**Retrieval pattern:**

```typescript
// Fetch and decrypt
const object = await workos.vault.getObject({
  name: 'stored_object_name', // From Step 6
  keyContext: {
    organization_id: 'org_123' // MUST match creation context
  }
});

const decryptedData = JSON.parse(object.value);
```

**CRITICAL:** Key context on retrieval MUST exactly match creation context or decryption fails.

## Step 8: Update Object Value

**Key context is immutable.** Only the value can be changed.

```typescript
// Update with optional version lock (recommended)
const updated = await workos.vault.updateObject({
  name: 'stored_object_name',
  keyContext: {
    organization_id: 'org_123'
  },
  value: JSON.stringify({ newData: 'updated_value' }),
  expectedVersion: object.version // Prevents race conditions
});
```

**Version lock behavior:**
- Omit `expectedVersion` → Overwrites current value
- Include `expectedVersion` → Fails if version changed (409 conflict)

## Step 9: Delete Object

Deletion is **soft delete** — data not immediately purged.

```typescript
await workos.vault.deleteObject({
  name: 'stored_object_name',
  keyContext: {
    organization_id: 'org_123'
  }
});
```

After deletion:
- Object unavailable to API operations immediately
- Physical data deletion happens after retention period (check docs for timeline)

## Step 10: BYOK Setup (Optional)

**BYOK = Bring Your Own Key** — customer-managed keys from AWS KMS, Azure Key Vault, or Google Cloud KMS.

### Decision Tree: BYOK vs WorkOS-Managed

```
Customer key management requirements?
  |
  +-- NONE --> Use WorkOS-managed keys (default, Steps 1-9 sufficient)
  |
  +-- REQUIRED --> Configure BYOK
                   |
                   +-- Provider?
                       |
                       +-- AWS KMS    --> Requires IAM role + KMS key ARN
                       +-- Azure      --> Requires Key Vault URI + managed identity
                       +-- Google KMS --> Requires service account + key path
```

**BYOK configuration location:** WorkOS Dashboard → Organizations → Select Org → Vault Settings

### BYOK IAM Requirements

**AWS KMS example permissions:**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "kms:Decrypt",
        "kms:Encrypt",
        "kms:GenerateDataKey"
      ],
      "Resource": "arn:aws:kms:REGION:ACCOUNT:key/KEY_ID"
    }
  ]
}
```

Check fetched BYOK doc for Azure/GCP equivalents.

### BYOK Key Matching

From fetched docs: CMK used **automatically** when key context matches BYOK configuration.

```
Configured BYOK for org_abc123 → CMK key_abc
Key context {"organization_id": "org_abc123"} → Uses key_abc
Key context {"organization_id": "org_xyz789"} → Uses WorkOS KEK (fallback)
```

No code changes needed after BYOK configuration.

## Verification Checklist (ALL MUST PASS)

Run these commands to confirm integration:

```bash
# 1. Check environment variables exist
printenv | grep WORKOS_API_KEY && echo "PASS: API key set" || echo "FAIL: No API key"
printenv | grep WORKOS_CLIENT_ID && echo "PASS: Client ID set" || echo "FAIL: No client ID"

# 2. Verify SDK installed
npm list @workos-inc/node 2>/dev/null | grep @workos-inc/node && echo "PASS: SDK installed" || echo "FAIL: SDK missing"

# 3. Test API connectivity
curl -X GET "https://api.workos.com/organizations" \
  -H "Authorization: Bearer $WORKOS_API_KEY" \
  -w "\nHTTP Status: %{http_code}\n" \
  | grep -q "200" && echo "PASS: API reachable" || echo "FAIL: API error"

# 4. Check object creation (replace with your test code path)
# Run your createObject implementation and verify no errors

# 5. Check object retrieval (replace with your test code path)
# Run your getObject implementation and verify decryption succeeds
```

**If check #3 fails with 401:** API key invalid or missing `sk_` prefix.

**If check #3 fails with 403:** API key lacks permissions for endpoint.

## Error Recovery

### "Invalid key context" on decryption

**Root cause:** Key context mismatch between create and retrieve.

Fix:
1. Check stored key context used during object creation
2. Ensure retrieval uses EXACT same context (key names and values)
3. Remember: Key context is case-sensitive

### "Organization not found" error

**Root cause:** Organization ID doesn't exist or API key lacks access.

Fix:
1. Verify organization exists: `curl https://api.workos.com/organizations/$ORG_ID -H "Authorization: Bearer $WORKOS_API_KEY"`
2. Check API key environment (staging vs production)
3. Confirm organization ID format: `organization_<uuid>`

### "Object version conflict" (409) on update

**Root cause:** Object modified between read and write (race condition).

Fix:
1. Fetch latest object version: `getObject()` or `getObjectMetadata()`
2. Include `expectedVersion` in `updateObject()` call
3. Implement retry logic with exponential backoff for concurrent updates

### "Key context exceeds maximum items"

**Root cause:** More than 10 key-value pairs in context.

Fix:
1. Count context items: `Object.keys(keyContext).length`
2. Consolidate context keys (e.g., combine `tenant_id` and `region` into `tenant_region`)
3. Redesign context for lower cardinality if needed

### "BYOK key not accessible" errors

**Root cause:** IAM permissions missing or CMK misconfigured.

Fix by provider:

**AWS KMS:**
```bash
# Test IAM permissions
aws kms describe-key --key-id $KEY_ARN
aws kms generate-data-key --key-id $KEY_ARN --key-spec AES_256
```

**Azure Key Vault:**
```bash
# Test access
az keyvault key show --vault-name $VAULT_NAME --name $KEY_NAME
```

**Google Cloud KMS:**
```bash
# Test access
gcloud kms keys describe $KEY_NAME --keyring $KEYRING --location $LOCATION
```

Check fetched BYOK doc for required permission lists.

### SDK import errors

**Root cause:** Package not installed or wrong import path.

Fix:
```bash
# Reinstall SDK
rm -rf node_modules/@workos-inc
npm install @workos-inc/node

# Check import path in code
grep "from '@workos-inc" src/**/*.ts
```

Correct import: `import { WorkOS } from '@workos-inc/node';`

### "API key invalid" (401) despite correct format

**Root cause:** Using staging key in production or vice versa.

Fix:
1. Check WorkOS Dashboard for key environment: https://dashboard.workos.com/api-keys
2. Verify application environment matches key environment
3. Staging keys start with `sk_test_`, production with `sk_live_`

## Related Skills

- **workos-audit-logs**: Track Vault object access for compliance
- **workos-directory-sync**: Sync user identities for per-user encryption contexts
- **workos-sso**: Integrate SSO with organization-scoped Vault data
